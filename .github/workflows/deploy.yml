name: Build and Deploy

on:
  push:
    branches:
      - '**'
  pull_request:
    branches: 
      - '**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    #Scan Dockerfile with Hadolint
    - name: Lint Dockerfile (Hadolint)
      uses: hadolint/hadolint-action@2332a7b74a6de0dda2e2221d575162eba76ba5e5  # v3.3.0
      with:
        dockerfile: Dockerfile
        failure-threshold: error

    #   with:
    #     fetch-depth: 0   # important for SonarQube

    # - name: Set up JDK (required for SonarQube Scanner)
    #   uses: actions/setup-java@v4
    #   with:
    #     distribution: 'temurin'
    #     java-version: '17'

    # - name: SonarQube Scan (SAST)
    #   uses: SonarSource/sonarqube-scan-action@v2
    #   env:
    #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
    #   with:
    #     args: >
    #       -Dsonar.projectKey=my-app
    #       -Dsonar.projectName=my-app
    #       -Dsonar.sources=.

    # # Optional but highly recommended
    # - name: SonarQube Quality Gate
    #   uses: SonarSource/sonarqube-quality-gate-action@v1
    #   env:
    #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    
    #Docker login

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3
    - name: Login to Docker Hub
      uses: docker/login-action@3227f5311cb93ffd14d13e65d8cc400d30f4dd8a  # v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    #Build image

    - name: Build Docker image
      uses: docker/build-push-action@8c1e8f8e5bf845ba3773a14f3967965548a2341e # v3
      with:
        context: .
        push: false
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/my-app:latest
          ${{ secrets.DOCKER_USERNAME }}/my-app:${{ github.sha }}

      #Scan the image with Trivy

    - name: Scan Docker image with Trivy
      uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
      with:
        image-ref: ${{ secrets.DOCKER_USERNAME }}/my-app:latest
        format: table
        exit-code: 1
        severity: CRITICAL,HIGH,MIDIUM

      #Push image only if scan passes  ##push only if Trivy passes
    - name: Push Docker image
      if: success() 
      uses: docker/build-push-action@8c1e8f8e5bf845ba3773a14f3967965548a2341e
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/my-app:latest
          ${{ secrets.DOCKER_USERNAME }}/my-app:${{ github.sha }}
